<div class="flight-form-container">

  <!-- Success Toast -->
  <app-error-toast
    [message]="successMessage"
    [visible]="showSuccess"
    [type]="'success'"
    [duration]="3000"
    (dismissed)="onSuccessDismissed()"
  >
  </app-error-toast>

  <!-- Error Toast -->
  <app-error-toast
    [message]="errorMessage"
    [visible]="showError"
    [type]="'error'"
    [duration]="5000"
    (dismissed)="onErrorDismissed()"
  >
  </app-error-toast>

  <!-- Header with Back Button on Left -->
  <div class="form-header">
    <button (click)="onCancel()" class="btn btn-back">
      {{ isViewMode ? "Back" : "Cancel" }}
    </button>
    <h2>{{ title }}</h2>
    <div class="header-spacer"></div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-state">
    <div class="spinner"></div>
    <p>Loading...</p>
  </div>

  <!-- Form Content -->
  <form *ngIf="!isLoading" [formGroup]="flightForm" (ngSubmit)="onSubmit()">
    <!-- Flight Number (View Only - Generated by Backend) -->
    <div class="form-group" *ngIf="!isCreateMode">
      <label>Flight Number</label>
      <div class="view-value">{{ flight?.flightNumber }}</div>
      <small class="field-note">Automatically generated</small>
    </div>

    <!-- Airline -->
    <div class="form-group">
      <label>Airline</label>
      <div *ngIf="isViewMode" class="view-value">{{ flight?.airline }}</div>
      <input
        *ngIf="isCreateMode"
        type="text"
        formControlName="airline"
        placeholder="Enter airline name"
        [class.error]="
          flightForm.get('airline')?.invalid &&
          flightForm.get('airline')?.touched
        "
      />
      <div *ngIf="isEditMode" class="view-value">{{ flight?.airline }}</div>
      <div
        class="error"
        *ngIf="
          flightForm.get('airline')?.invalid &&
          flightForm.get('airline')?.touched
        "
      >
        Airline is required (2-50 characters)
      </div>
    </div>

    <!-- Destination -->
    <div class="form-group">
      <label>Destination</label>
      <div *ngIf="isViewMode || isEditMode" class="view-value">
        {{ flight?.destination }}
      </div>
      <input
        *ngIf="isCreateMode"
        type="text"
        formControlName="destination"
        placeholder="Enter destination"
        [class.error]="
          flightForm.get('destination')?.invalid &&
          flightForm.get('destination')?.touched
        "
      />
      <div
        class="error"
        *ngIf="
          flightForm.get('destination')?.invalid &&
          flightForm.get('destination')?.touched
        "
      >
        Destination is required (2-100 characters)
      </div>
    </div>

    <!-- Gate with Inline Editing -->
    <div class="form-group">
      <label>Gate</label>

      <!-- View Mode -->
      <div *ngIf="isViewMode" class="view-value">{{ flight?.gate }}</div>

      <!-- Create Mode -->
      <input
        *ngIf="isCreateMode"
        type="text"
        formControlName="gate"
        placeholder="e.g., A12, B3"
        [class.error]="
          flightForm.get('gate')?.invalid && flightForm.get('gate')?.touched
        "
      />

      <!-- Edit Mode - Inline Editing -->
      <div *ngIf="isEditMode && !isEditingGate" class="inline-edit">
        <span class="view-value">{{ flightForm.get("gate")?.value }}</span>
        <button type="button" (click)="startEditGate()" class="btn-edit">
          Edit
        </button>
      </div>

      <input
        *ngIf="isEditMode && isEditingGate"
        type="text"
        formControlName="gate"
        class="inline-edit-input"
        [class.error]="flightForm.get('gate')?.invalid"
      />

      <!-- Edit Mode Actions -->
      <div *ngIf="isEditMode && isEditingGate" class="inline-edit-actions">
        <button type="button" (click)="saveGate()" class="btn-save">
          Save
        </button>
        <button type="button" (click)="cancelEditGate()" class="btn-cancel">
          Cancel
        </button>
      </div>

      <div
        class="error"
        *ngIf="
          flightForm.get('gate')?.invalid && flightForm.get('gate')?.touched
        "
      >
        Valid gate format required (e.g., A12, B3)
      </div>
      <small class="field-note"
        >Format: 1-2 letters followed by 1-3 numbers</small
      >
    </div>

    <!-- Departure Time -->
    <div class="form-group">
      <label>Departure Time</label>
      <div *ngIf="isViewMode" class="view-value">
        {{ flight?.departureTime }}
      </div>
      <input
        *ngIf="!isViewMode"
        type="datetime-local"
        formControlName="departureTime"
        [class.error]="
          flightForm.get('departureTime')?.invalid &&
          flightForm.get('departureTime')?.touched
        "
      />
      <div
        class="error"
        *ngIf="
          flightForm.get('departureTime')?.invalid &&
          flightForm.get('departureTime')?.touched
        "
      >
        Valid departure time is required
      </div>
    </div>

    <!-- Status -->
    <div class="form-group">
      <label>Status</label>

      <!-- View Mode -->
      <div *ngIf="isViewMode" class="view-value">
        <span class="status-badge status-{{ flight?.status | lowercase }}">
          {{ flight?.status }}
        </span>
      </div>

      <!-- Create Mode (Fixed) -->
      <div *ngIf="isCreateMode" class="view-value">
        <span class="status-badge status-scheduled">Scheduled</span>
      </div>

      <!-- Edit Mode (Editable) -->
      <select *ngIf="isEditMode" formControlName="status" class="status-select">
        <option *ngFor="let option of statusOptions" [value]="option.value">
          {{ option.display }}
        </option>
      </select>
    </div>

    <!-- Action Buttons -->
    <div class="form-actions">
      <!-- View Mode Actions -->
      <button
        *ngIf="isViewMode"
        type="button"
        (click)="navigateToEdit()"
        class="btn btn-primary"
      >
        Edit Flight
      </button>

      <!-- Create/Edit Submit -->
      <button
        *ngIf="!isViewMode"
        type="submit"
        [disabled]="!canSubmit || isLoading"
        class="btn btn-primary"
      >
        {{ isCreateMode ? "Create Flight" : "Update Flight" }}
      </button>
    </div>
  </form>
</div>

<!-- Confirmation Dialog -->
<div *ngIf="showConfirmationDialog" class="confirmation-dialog-overlay">
  <div class="confirmation-dialog">
    <h3>Confirm Update</h3>
    <p>Are you sure you want to update this flight?</p>
    <div class="dialog-actions">
      <button
        type="button"
        (click)="confirmUpdate()"
        class="btn btn-primary"
        [disabled]="isLoading"
      >
        {{ isLoading ? "Updating..." : "Yes" }}
      </button>
      <button
        type="button"
        (click)="cancelUpdate()"
        class="btn btn-secondary"
        [disabled]="isLoading"
      >
        Cancel
      </button>
    </div>
  </div>
</div>
